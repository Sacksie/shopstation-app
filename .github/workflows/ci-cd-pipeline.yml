name: ğŸš€ ShopStation CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # ============================================================================
  # QUALITY GATES: Comprehensive Testing & Validation
  # ============================================================================
  quality-gates:
    name: ğŸ” Quality Gates & Testing
    runs-on: ubuntu-latest
    
    services:
      # Test database for integration tests
      test-db:
        image: alpine:latest
        options: >-
          --health-cmd "echo 'healthy'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # Checkout code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Setup Node.js with caching
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # ========================================================================
      # BACKEND TESTING PIPELINE
      # ========================================================================
      
      # Install backend dependencies
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: |
          npm ci --only=production=false
          echo "âœ… Backend dependencies installed"

      # Backend: Environment Configuration Test
      - name: ğŸ”§ Validate Backend Environment Configuration
        working-directory: ./backend
        env:
          NODE_ENV: test
          ADMIN_PASSWORD: test-admin-password-for-ci
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-validation-only
        run: |
          echo "ğŸ” Testing environment configuration..."
          npm run check-env
          echo "âœ… Environment configuration valid"

      # Backend: Unit Tests
      - name: ğŸ§ª Backend Unit Tests
        working-directory: ./backend
        env:
          NODE_ENV: test
          ADMIN_PASSWORD: test-admin-password-for-ci
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-validation-only
        run: |
          echo "ğŸ§ª Running backend unit tests..."
          npm test -- --verbose --coverage
          echo "âœ… Backend unit tests passed"

      # Backend: Integration Tests
      - name: ğŸ”— Backend Integration Tests
        working-directory: ./backend
        env:
          NODE_ENV: test
          ADMIN_PASSWORD: test-admin-password-for-ci
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-validation-only
        run: |
          echo "ğŸ”— Running backend integration tests..."
          # Test API endpoints end-to-end
          npm test -- --testMatch="**/tests/**/*.integration.test.js" --verbose
          echo "âœ… Backend integration tests passed"

      # Backend: Security Scan
      - name: ğŸ›¡ï¸ Backend Security Scan
        working-directory: ./backend
        run: |
          echo "ğŸ›¡ï¸ Scanning for security vulnerabilities..."
          npm audit --audit-level=moderate
          echo "âœ… Security scan completed"

      # Backend: Database Tests
      - name: ğŸ—„ï¸ Database Operations Tests
        working-directory: ./backend
        env:
          NODE_ENV: test
          ADMIN_PASSWORD: test-admin-password-for-ci
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-validation-only
        run: |
          echo "ğŸ—„ï¸ Testing database operations..."
          # Test backup/restore functionality
          node -e "
            const { cloudBackup } = require('./utils/cloudBackup');
            const testBackup = async () => {
              console.log('Testing backup system...');
              const result = await cloudBackup.createFullBackup('ci-test');
              if (result.success) {
                console.log('âœ… Backup system functional');
              } else {
                console.error('âŒ Backup system failed');
                process.exit(1);
              }
            };
            testBackup();
          "

      # ========================================================================
      # FRONTEND TESTING PIPELINE
      # ========================================================================

      # Install frontend dependencies
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: |
          npm ci
          echo "âœ… Frontend dependencies installed"

      # Frontend: Environment Configuration Test
      - name: ğŸ”§ Validate Frontend Environment Configuration
        working-directory: ./frontend
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001
          REACT_APP_ENV: test
        run: |
          echo "ğŸ” Testing frontend environment configuration..."
          node -e "
            const config = require('./src/config/environments.js');
            console.log('Environment:', config.default.environment);
            console.log('API URL:', config.default.api.baseUrl);
            if (!config.default.api.baseUrl) {
              console.error('âŒ Frontend environment configuration invalid');
              process.exit(1);
            }
            console.log('âœ… Frontend environment configuration valid');
          "

      # Frontend: Unit Tests
      - name: ğŸ§ª Frontend Unit Tests
        working-directory: ./frontend
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001
          REACT_APP_ENV: test
        run: |
          echo "ğŸ§ª Running frontend unit tests..."
          npm test -- --coverage --watchAll=false --testResultsProcessor=jest-junit
          echo "âœ… Frontend unit tests passed"

      # Frontend: Component Integration Tests
      - name: ğŸ”— Frontend Component Integration Tests
        working-directory: ./frontend
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001
          REACT_APP_ENV: test
        run: |
          echo "ğŸ”— Running frontend component integration tests..."
          # Test critical user journeys
          npm test -- --testMatch="**/*.integration.test.js" --watchAll=false
          echo "âœ… Frontend integration tests passed"

      # Frontend: Build Test
      - name: ğŸ—ï¸ Frontend Build Test
        working-directory: ./frontend
        env:
          CI: true
          REACT_APP_API_URL: http://localhost:3001
          REACT_APP_ENV: test
        run: |
          echo "ğŸ—ï¸ Testing frontend build process..."
          npm run build
          echo "âœ… Frontend build successful"

      # ========================================================================
      # COMPREHENSIVE QUALITY VALIDATION
      # ========================================================================

      # Code Quality Check
      - name: ğŸ“Š Code Quality Analysis
        run: |
          echo "ğŸ“Š Running code quality analysis..."
          
          # Check for common code quality issues
          echo "ğŸ” Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" --include="*.js" --include="*.jsx" backend/ frontend/ || true; then
            echo "âš ï¸  Found TODO/FIXME comments - consider addressing before production"
          fi
          
          # Check for console.log in production code (except monitoring)
          echo "ğŸ” Checking for debug statements..."
          if grep -r "console\.log" --include="*.js" --include="*.jsx" frontend/src/ --exclude-dir=config || true; then
            echo "âš ï¸  Found console.log statements in frontend - consider removing for production"
          fi
          
          echo "âœ… Code quality analysis completed"

      # Test Coverage Validation
      - name: ğŸ“ˆ Test Coverage Validation
        run: |
          echo "ğŸ“ˆ Validating test coverage..."
          
          # Check backend test coverage
          echo "Backend test coverage summary:"
          if [ -f "backend/coverage/coverage-summary.json" ]; then
            node -e "
              const coverage = require('./backend/coverage/coverage-summary.json');
              const total = coverage.total;
              console.log('Lines:', total.lines.pct + '%');
              console.log('Functions:', total.functions.pct + '%');
              console.log('Branches:', total.branches.pct + '%');
              console.log('Statements:', total.statements.pct + '%');
              
              if (total.lines.pct < 70) {
                console.error('âŒ Backend test coverage below 70% - ' + total.lines.pct + '%');
                process.exit(1);
              }
              console.log('âœ… Backend test coverage acceptable: ' + total.lines.pct + '%');
            "
          else
            echo "âš ï¸  Backend coverage report not found"
          fi
          
          echo "âœ… Test coverage validation completed"

  # ============================================================================
  # PERFORMANCE & LOAD TESTING
  # ============================================================================
  performance-tests:
    name: âš¡ Performance & Load Testing
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Performance testing
      - name: âš¡ Backend Performance Tests
        working-directory: ./backend
        env:
          NODE_ENV: test
          ADMIN_PASSWORD: test-admin-password-for-ci
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-validation-only
        run: |
          echo "âš¡ Running performance tests..."
          npm ci
          
          # Test API response times
          node -e "
            const express = require('express');
            const app = express();
            const config = require('./config/environments');
            
            app.use(express.json());
            app.get('/test-health', (req, res) => res.json({status: 'ok'}));
            
            const server = app.listen(3001, () => {
              console.log('Test server started');
              
              // Test response time
              const start = Date.now();
              const http = require('http');
              
              const req = http.request({
                hostname: 'localhost',
                port: 3001,
                path: '/test-health',
                method: 'GET'
              }, (res) => {
                const responseTime = Date.now() - start;
                console.log('Response time:', responseTime + 'ms');
                
                if (responseTime > 1000) {
                  console.error('âŒ Response time too slow: ' + responseTime + 'ms');
                  process.exit(1);
                }
                
                console.log('âœ… Performance test passed');
                server.close();
              });
              
              req.on('error', (e) => {
                console.error('Performance test error:', e);
                process.exit(1);
              });
              
              req.end();
            });
          "

  # ============================================================================
  # DEPLOYMENT TO STAGING
  # ============================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [quality-gates, performance-tests]
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Staging Environment
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "ğŸ“ Branch: ${{ github.ref }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "âœ… Staging deployment completed"
          
          # In a real implementation, this would:
          # - Deploy to staging Railway environment
          # - Run staging-specific health checks
          # - Notify team of successful deployment

  # ============================================================================
  # DEPLOYMENT TO PRODUCTION
  # ============================================================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [quality-gates, performance-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Pre-deployment health check
      - name: ğŸ¥ Pre-deployment Health Check
        run: |
          echo "ğŸ¥ Running pre-deployment health checks..."
          
          # Check current production health
          curl -f https://backend-production-2cbb.up.railway.app/api/health || {
            echo "âš ï¸  Current production health check failed - proceeding with caution"
          }
          
          echo "âœ… Pre-deployment checks completed"

      # Production deployment happens automatically via Railway/Vercel
      # when code is pushed to main branch
      - name: ğŸŒŸ Production Deployment
        run: |
          echo "ğŸŒŸ Production deployment initiated..."
          echo "ğŸ“ Branch: ${{ github.ref }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ·ï¸  Tag: ${{ github.ref_name }}"
          
          # Railway and Vercel will automatically deploy
          echo "ğŸš€ Railway (backend) will auto-deploy from this commit"
          echo "ğŸš€ Vercel (frontend) will auto-deploy from this commit"
          
          echo "â³ Waiting 60 seconds for deployments to complete..."
          sleep 60

      # Post-deployment verification
      - name: âœ… Post-deployment Health Check
        run: |
          echo "âœ… Running post-deployment health checks..."
          
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ” Health check attempt $attempt/$max_attempts..."
            
            if curl -f https://backend-production-2cbb.up.railway.app/api/health; then
              echo "âœ… Backend health check passed"
              
              # Verify monitoring systems
              if curl -f https://backend-production-2cbb.up.railway.app/api/system/status; then
                echo "âœ… Monitoring systems operational"
                break
              else
                echo "âš ï¸  Monitoring systems check failed"
              fi
            else
              echo "âŒ Backend health check failed on attempt $attempt"
              
              if [ $attempt -eq $max_attempts ]; then
                echo "ğŸš¨ CRITICAL: Production deployment failed health checks!"
                echo "ğŸ”„ Consider rollback procedures"
                exit 1
              fi
              
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
            fi
            
            attempt=$((attempt + 1))
          done
          
          echo "ğŸ‰ Production deployment successful!"

      # Business metrics validation
      - name: ğŸ“Š Business Metrics Validation
        run: |
          echo "ğŸ“Š Validating business metrics..."
          
          # Check that monitoring systems are tracking correctly
          response=$(curl -s https://backend-production-2cbb.up.railway.app/api/system/status)
          
          if echo "$response" | grep -q '"status":"HEALTHY"'; then
            echo "âœ… Business monitoring systems healthy"
          else
            echo "âš ï¸  Business monitoring systems may need attention"
          fi
          
          # Check backup systems
          backup_response=$(curl -s https://backend-production-2cbb.up.railway.app/api/system/backups)
          
          if echo "$backup_response" | grep -q '"success":true'; then
            echo "âœ… Backup systems operational"
          else
            echo "âš ï¸  Backup systems may need attention"
          fi
          
          echo "âœ… Business metrics validation completed"

      # Deployment success notification
      - name: ğŸ‰ Deployment Success Notification
        run: |
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "=================================="
          echo "ğŸ“ Environment: Production"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ• Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ”— Backend: https://backend-production-2cbb.up.railway.app"
          echo "ğŸ”— Frontend: https://shopstation.co.uk"
          echo "ğŸ¥ Health: https://backend-production-2cbb.up.railway.app/api/health"
          echo "ğŸ“Š Status: https://backend-production-2cbb.up.railway.app/api/system/status"
          echo "=================================="